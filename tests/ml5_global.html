<html>
  <head>
    <meta charset="UTF-8" />
    <title>HandPose — Mão Esquerda + Mão Direita Pinch</title>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #111;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <video
      id="video"
      width="640"
      height="480"
      autoplay
      playsinline
      style="display: none"
    ></video>
    <canvas
      id="videoCanvas"
      width="300"
      height="220"
      style="
        position: absolute;
        right: 12px;
        top: 80px;
        width: 300px;
        height: 220px;
        border: 2px solid rgba(0, 0, 0, 0.6);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.4);
        z-index: 60;
        pointer-events: none;
      "
    ></canvas>

    <script>
      const canvas = document.getElementById("videoCanvas");
      const ctx = canvas.getContext("2d");

      const W = canvas.width;
      const H = canvas.height;

      let handPose;
      let hands = [];
      let video;

      let circleX = W / 2;
      let circleY = H / 2;
      const smoothing = 0.2;

      async function preload() {
        video = await getVideo();
        handPose = await ml5.handPose({ flipped: true });
        await handPose.detectStart(video, gotHands);
        render();
      }

      window.addEventListener("DOMContentLoaded", preload);

      function gotHands(results) {
        hands = results;
      }

      function render() {
        ctx.clearRect(0, 0, W, H);

        // desenhar vídeo espelhado com opacidade
        ctx.save();
        ctx.globalAlpha = 0.6;
        ctx.translate(W, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, W, H);
        ctx.restore();
        ctx.globalAlpha = 1.0;

        // overlay leve
        ctx.fillStyle = "rgba(255,255,255,0.15)";
        ctx.fillRect(0, 0, W, H);

        if (hands.length > 0) {
          // --- MÃO ESQUERDA: seguir o dedo indicador ---
          const leftHand = hands.find(
            (hand) =>
              hand.handedness && hand.handedness.toLowerCase() === "left"
          );

          if (leftHand) {
            const indexTip = leftHand.keypoints.find(
              (kp) => kp.name === "index_finger_tip"
            );
            if (indexTip) {
              ctx.fillStyle = "#863228";
              ctx.beginPath();
              ctx.arc(indexTip.x, indexTip.y, 10, 0, 2 * Math.PI);
              ctx.fill();

              circleX += (indexTip.x - circleX) * smoothing;
              circleY += (indexTip.y - circleY) * smoothing;
            }
          }

          // --- MÃO DIREITA: detectar "pinch" entre polegar e indicador ---
          const rightHand = hands.find(
            (hand) =>
              hand.handedness && hand.handedness.toLowerCase() === "right"
          );

          if (rightHand) {
            const indexTip = rightHand.keypoints.find(
              (kp) => kp.name === "index_finger_tip"
            );
            const thumbTip = rightHand.keypoints.find(
              (kp) => kp.name === "thumb_tip"
            );

            if (indexTip && thumbTip) {
              const centerX = (indexTip.x + thumbTip.x) / 2;
              const centerY = (indexTip.y + thumbTip.y) / 2;

              const dx = indexTip.x - thumbTip.x;
              const dy = indexTip.y - thumbTip.y;
              const pinch = Math.sqrt(dx * dx + dy * dy);

              ctx.fillStyle = "rgba(134, 50, 40, 0.6)";
              ctx.strokeStyle = "#000";
              ctx.lineWidth = 2;
              ctx.beginPath();
              ctx.arc(centerX, centerY, pinch / 2, 0, 2 * Math.PI);
              ctx.fill();
              ctx.stroke();
            }
          }
        }

        // círculo branco suave (seguindo a mão esquerda)
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(circleX, circleY, 5, 0, 2 * Math.PI);
        ctx.fill();

        requestAnimationFrame(render);
      }

      async function getVideo() {
        const videoElement = document.getElementById("video");
        videoElement.width = W;
        videoElement.height = H;

        const capture = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        videoElement.srcObject = capture;
        videoElement.play();

        return videoElement;
      }
    </script>
  </body>
</html>
